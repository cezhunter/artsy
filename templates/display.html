<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Art Display</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        .display-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .artwork-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.3s ease;
        }

        .artwork-image.visible {
            opacity: 1;
        }

        .artwork-image.rotate-90 {
            transform: rotate(90deg);
            max-width: 100vh;
            max-height: 100vw;
        }

        .artwork-image.rotate-180 {
            transform: rotate(180deg);
        }

        .artwork-image.rotate-270 {
            transform: rotate(270deg);
            max-width: 100vh;
            max-height: 100vw;
        }
    </style>
</head>
<body>
    <div class="display-container">
        <img class="artwork-image" id="artworkImage" alt="Artwork">
    </div>

    <script>
        let state = {
            paused: false,
            timerSeconds: 30,
            rotation: 0
        };

        let timerInterval = null;
        const image = document.getElementById('artworkImage');

        function updateDisplay(artwork) {
            if (!artwork || !artwork.image_url) {
                image.classList.remove('visible');
                return;
            }

            const newSrc = artwork.image_url + '?t=' + Date.now();
            image.classList.remove('visible');
            image.onload = () => {
                image.classList.add('visible');
            };
            image.src = newSrc;
        }

        function updateRotation(rotation) {
            state.rotation = rotation;
            image.classList.remove('rotate-90', 'rotate-180', 'rotate-270');
            if (rotation === 90) {
                image.classList.add('rotate-90');
            } else if (rotation === 180) {
                image.classList.add('rotate-180');
            } else if (rotation === 270) {
                image.classList.add('rotate-270');
            }
        }

        function updatePaused(paused) {
            state.paused = paused;
            if (paused) {
                stopTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            stopTimer();
            if (!state.paused && state.timerSeconds > 0) {
                timerInterval = setInterval(() => {
                    if (!state.paused) {
                        fetch('/api/next', { method: 'POST' });
                    }
                }, state.timerSeconds * 1000);
            }
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function connectSSE() {
            const eventSource = new EventSource('/api/events');

            eventSource.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleMessage(message);
                } catch (e) {
                    console.error('Error parsing SSE message:', e);
                }
            };

            eventSource.onerror = () => {
                eventSource.close();
                setTimeout(connectSSE, 3000);
            };
        }

        function handleMessage(message) {
            const { type, data } = message;

            switch (type) {
                case 'state':
                    updatePaused(data.paused);
                    updateRotation(data.rotation || 0);
                    state.timerSeconds = data.timer_seconds;
                    updateDisplay(data.current_artwork);
                    if (!data.paused) startTimer();
                    break;

                case 'mode_change':
                case 'artwork_change':
                case 'artwork_saved':
                case 'artwork_deleted':
                case 'query_change':
                    updateDisplay(data.current_artwork);
                    startTimer();
                    break;

                case 'timer_change':
                    state.timerSeconds = data.timer_seconds;
                    startTimer();
                    break;

                case 'pause_change':
                    updatePaused(data.paused);
                    break;

                case 'rotation_change':
                    updateRotation(data.rotation);
                    break;
            }
        }

        // Initialize
        fetch('/api/init', { method: 'POST' })
            .then(() => connectSSE())
            .catch(console.error);
    </script>
</body>
</html>
